[TOC]

# ä»»åŠ¡5ï¼šå›¾åƒå¢å¼º

## 1.ä»»åŠ¡ç›®æ ‡

<!-- 1. 
2. 
3. 
4.  -->

- äº†è§£å›¾åƒå¢å¼ºçš„æ–¹æ³•
- èƒ½å¤Ÿé€šè¿‡ä¼ ç»Ÿçš„ç®—æ³•å¢å¼ºå›¾åƒ
- å­¦ä¹ åˆ©ç”¨æ·±åº¦å­¦ä¹ çš„æ–¹æ³•å¢å¼ºå›¾åƒ


## 2.ä»»åŠ¡æè¿°


- åœ¨è¿‡å»çš„å‡ å¹´ä¸­ï¼Œç´§å‡‘å‹ç›¸æœºä¼ æ„Ÿå™¨çš„è´¨é‡æœ‰äº†æ˜¾ç€æé«˜ï¼Œè¿™ä½¿ç§»åŠ¨æ‘„å½±è¾¾åˆ°äº†æ–°çš„æ°´å¹³ã€‚ç”±äºé‡‡ç”¨äº†å…ˆè¿›çš„åå¤„ç†è½¯ä»¶å’Œç¡¬ä»¶å·¥å…·ï¼Œå³ä½¿æ˜¯ä½ç«¯è®¾å¤‡ä¹Ÿèƒ½åœ¨é€‚å½“çš„ç…§æ˜æ¡ä»¶ä¸‹æ‹æ‘„å‡ºç›¸å½“ä¸é”™çš„ç…§ç‰‡ã€‚ä½†æ˜¯ï¼Œå°±è‰ºæœ¯è´¨é‡è€Œè¨€ï¼Œç§»åŠ¨è®¾å¤‡ä»è½åäºå…¶æ•°ç å•åç›¸æœºã€‚è¾ƒå¤§çš„ä¼ æ„Ÿå™¨å’Œé«˜å…‰åœˆå…‰å­¦å…ƒä»¶å¯æä¾›æ›´å¥½çš„ç…§ç‰‡åˆ†è¾¨ç‡ï¼Œè‰²å½©å†ç°å’Œæ›´ä½çš„å™ªç‚¹ï¼Œè€Œå®ƒä»¬çš„é™„åŠ ä¼ æ„Ÿå™¨æœ‰åŠ©äºå¾®è°ƒæ‹æ‘„å‚æ•°ã€‚è¿™äº›ç‰©ç†å·®å¼‚ä¼šå¯¼è‡´ä¸¥é‡çš„éšœç¢ï¼Œä½¿å¾—ç´§å‡‘å‹ç§»åŠ¨è®¾å¤‡æ— æ³•è¾¾åˆ°DSLRç›¸æœºçš„è´¨é‡ã€‚
- å°½ç®¡å­˜åœ¨è®¸å¤šç”¨äºè‡ªåŠ¨å›¾åƒå¢å¼ºçš„æ‘„å½±å¸ˆå·¥å…·ï¼Œä½†å®ƒä»¬é€šå¸¸åªä¸“æ³¨äºè°ƒæ•´å…¨å±€å‚æ•°ï¼ˆä¾‹å¦‚å¯¹æ¯”åº¦æˆ–äº®åº¦ï¼‰ï¼Œè€Œä¸ä¼šæé«˜çº¹ç†è´¨é‡æˆ–ä¸è€ƒè™‘å›¾åƒè¯­ä¹‰ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œå®ƒä»¬é€šå¸¸åŸºäºä¸€ç»„é¢„å®šä¹‰çš„è§„åˆ™ï¼Œè¿™äº›è§„åˆ™å¹¶ä¸æ€»æ˜¯è€ƒè™‘ç‰¹å®šè®¾å¤‡çš„ç»†èŠ‚ã€‚å› æ­¤ï¼Œç…§ç‰‡åæœŸå¤„ç†çš„ä¸»è¦æ–¹æ³•ä»ç„¶åŸºäºä½¿ç”¨ä¸“ç”¨æ¶¦é¥°è½¯ä»¶çš„æ‰‹åŠ¨å›¾åƒæ ¡æ­£ã€‚



## 3.çŸ¥è¯†å‡†å¤‡


### 3.1å›¾åƒæ¨¡ç³Šäº§ç”Ÿçš„åŸå› 
1. ç›¸æœºæŠ–åŠ¨ï¼Œæ‹æ‘„æ—¶ç›¸æœºä¸ç¨³ï¼Œå…¨éƒ¨ç”»é¢è¢«æ¨¡ç³Šã€‚
2. ç‰©ä½“çš„è¿åŠ¨ï¼Œéƒ¨åˆ†ç‰©ä½“è¿åŠ¨ï¼Œä¸åŒåŒºåŸŸæ¨¡ç³Šä¸åŒã€‚
3. é•œå¤´å¤±ç„¦ï¼Œå¤§å…‰åœˆå°æ™¯æ·±æ—¶çš„æ•ˆæœï¼Œç­‰ç­‰ã€‚


### 3.2åŸºäºç›´æ–¹å›¾å‡è¡¡åŒ–çš„å›¾åƒå¢å¼º


ç›´æ–¹å›¾å‡è¡¡åŒ–æ˜¯é€šè¿‡è°ƒæ•´å›¾åƒçš„ç°é˜¶åˆ†å¸ƒï¼Œä½¿å¾—åœ¨0~255ç°é˜¶ä¸Šçš„åˆ†å¸ƒæ›´åŠ å‡è¡¡ï¼Œæé«˜äº†å›¾åƒçš„å¯¹æ¯”åº¦ï¼Œè¾¾åˆ°æ”¹å–„å›¾åƒä¸»è§‚è§†è§‰æ•ˆæœçš„ç›®çš„ã€‚å¯¹æ¯”åº¦è¾ƒä½çš„å›¾åƒé€‚åˆä½¿ç”¨ç›´æ–¹å›¾å‡è¡¡åŒ–æ–¹æ³•æ¥å¢å¼ºå›¾åƒç»†èŠ‚ã€‚


### 3.3åŸºäºæ‹‰æ™®æ‹‰æ–¯ç®—å­çš„å›¾åƒå¢å¼º


ä½¿ç”¨ä¸­å¿ƒä¸º5çš„8é‚»åŸŸæ‹‰æ™®æ‹‰æ–¯ç®—å­ä¸å›¾åƒå·ç§¯å¯ä»¥è¾¾åˆ°é”åŒ–å¢å¼ºå›¾åƒçš„ç›®çš„ï¼Œæ‹‰æ™®æ‹‰æ–¯ç®—å­å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

$$
 \begin{matrix}
   0 & -1& 0 \\
   -0 & 5& -1 \\
   0 & -1& 0 
  \end{matrix} 
$$
æ‹‰æ™®æ‹‰æ–¯ç®—å­å¯ä»¥å¢å¼ºå±€éƒ¨çš„å›¾åƒå¯¹æ¯”åº¦ã€‚

### 3.4åŸºäºå¯¹æ•°Logå˜æ¢çš„å›¾åƒå¢å¼º


å¯¹æ•°å˜æ¢å¯ä»¥å°†å›¾åƒçš„ä½ç°åº¦å€¼éƒ¨åˆ†æ‰©å±•ï¼Œæ˜¾ç¤ºå‡ºä½ç°åº¦éƒ¨åˆ†æ›´å¤šçš„ç»†èŠ‚ï¼Œå°†å…¶é«˜ç°åº¦å€¼éƒ¨åˆ†å‹ç¼©ï¼Œå‡å°‘é«˜ç°åº¦å€¼éƒ¨åˆ†çš„ç»†èŠ‚ï¼Œä»è€Œè¾¾åˆ°å¼ºè°ƒå›¾åƒä½ç°åº¦éƒ¨åˆ†çš„ç›®çš„ã€‚å˜æ¢æ–¹æ³•ï¼š

<!-- <div align=center>
    <img src="./img/ch5/1.jpg" width="300"/>
</div> -->

$$s=c\cdot log_{v+1}{(1+v\cdot r)} \qquad r\in [0,1]$$




å¯¹æ•°å˜æ¢å¯¹å›¾åƒä½ç°åº¦éƒ¨åˆ†ç»†èŠ‚å¢å¼ºçš„åŠŸèƒ½è¿‡å¯ä»¥ä»å¯¹æ•°å›¾ä¸Šç›´è§‚ç†è§£ï¼š
<div align=center>
    <!-- ![åº”ç”¨åœºæ™¯](./img/16cvåº”ç”¨åœºæ™¯.jpg) -->
    <img src="./img/ch5/2.jpg" width="300"/>
</div>


- xè½´çš„0.4å¤§çº¦å¯¹åº”äº†yè½´çš„0.8ï¼Œå³åŸå›¾ä¸Š0~0.4çš„ä½ç°åº¦éƒ¨åˆ†ç»è¿‡å¯¹æ•°è¿ç®—åæ‰©å±•åˆ°0~0.8çš„éƒ¨åˆ†ï¼Œè€Œæ•´ä¸ª0.4~1çš„é«˜ç°åº¦éƒ¨åˆ†è¢«æŠ•å½±åˆ°åªæœ‰0.8~1çš„åŒºé—´ï¼Œè¿™æ ·å°±è¾¾åˆ°äº†æ‰©å±•å’Œå¢å¼ºä½ç°åº¦éƒ¨åˆ†ï¼Œå‹ç¼©é«˜ç°åº¦éƒ¨åˆ†çš„å€¼çš„åŠŸèƒ½ã€‚
- ä»ä¸Šå›¾è¿˜å¯ä»¥çœ‹åˆ°ï¼Œå¯¹äºä¸åŒçš„åº•æ•°ï¼Œåº•æ•°è¶Šå¤§ï¼Œå¯¹ä½ç°åº¦éƒ¨åˆ†çš„æ‰©å±•å°±è¶Šå¼ºï¼Œå¯¹é«˜ç°åº¦éƒ¨åˆ†çš„å‹ç¼©ä¹Ÿå°±è¶Šå¼ºã€‚


### 3.5åŸºäºä¼½é©¬å˜æ¢çš„å›¾åƒå¢å¼º

ä¼½é©¬å˜æ¢ä¸»è¦ç”¨äºå›¾åƒçš„æ ¡æ­£ï¼Œå°†ç°åº¦è¿‡é«˜æˆ–è€…ç°åº¦è¿‡ä½çš„å›¾ç‰‡è¿›è¡Œä¿®æ­£ï¼Œå¢å¼ºå¯¹æ¯”åº¦ã€‚å˜æ¢å…¬å¼å°±æ˜¯å¯¹åŸå›¾åƒä¸Šæ¯ä¸€ä¸ªåƒç´ å€¼åšä¹˜ç§¯è¿ç®—ï¼š

<!-- <div align=center>
    <img src="./img/ch5/3.jpg" width="300"/>
</div> -->

$$s=cr^\gamma \qquad \gamma \in [0,1]$$

ä¼½é©¬å˜æ¢å¯¹å›¾åƒçš„ä¿®æ­£ä½œç”¨å…¶å®å°±æ˜¯é€šè¿‡å¢å¼ºä½ç°åº¦æˆ–é«˜ç°åº¦çš„ç»†èŠ‚å®ç°çš„ï¼Œä»ä¼½é©¬æ›²çº¿å¯ä»¥ç›´è§‚ç†è§£ï¼š

<div align=center>
    <!-- ![åº”ç”¨åœºæ™¯](./img/16cvåº”ç”¨åœºæ™¯.jpg) -->
    <img src="./img/ch5/4.jpg" width="300"/>
</div>

- Î³å€¼ä»¥1ä¸ºåˆ†ç•Œï¼Œå€¼è¶Šå°ï¼Œå¯¹å›¾åƒä½ç°åº¦éƒ¨åˆ†çš„æ‰©å±•ä½œç”¨å°±è¶Šå¼ºï¼Œå€¼è¶Šå¤§ï¼Œå¯¹å›¾åƒé«˜ç°åº¦éƒ¨åˆ†çš„æ‰©å±•ä½œç”¨å°±è¶Šå¼ºï¼Œé€šè¿‡ä¸åŒçš„Î³å€¼ï¼Œå°±å¯ä»¥è¾¾åˆ°å¢å¼ºä½ç°åº¦æˆ–é«˜ç°åº¦éƒ¨åˆ†ç»†èŠ‚çš„ä½œç”¨ã€‚
- ä¼½é©¬å˜æ¢å¯¹äºå›¾åƒå¯¹æ¯”åº¦åä½ï¼Œå¹¶ä¸”æ•´ä½“äº®åº¦å€¼åé«˜ï¼ˆå¯¹äºäºç›¸æœºè¿‡æ›ï¼‰æƒ…å†µä¸‹çš„å›¾åƒå¢å¼ºæ•ˆæœæ˜æ˜¾ã€‚



### 3.6 åŸºäºå·ç§¯ç¥ç»ç½‘ç»œçš„å›¾åƒå¢å¼º

åŸºäºæ·±åº¦å­¦ä¹ çš„æ–¹æ³•å’Œä¼ ç»Ÿçš„ä¼˜åŒ–çš„æ–¹æ³•éƒ½æå‡ºäº†å¯¹äºå›¾åƒçš„éå‡åŒ€æ¨¡ç³Šé—®é¢˜è¿›è¡Œäº†è§£å†³ï¼Œä½†å¯¹äºåŠ¨æ€åœºæ™¯çš„æ¨¡ç³Šé—®é¢˜ï¼Œä¹Ÿå°±æ˜¯å›¾åƒä¸­åªæœ‰å±€éƒ¨åŒºåŸŸå­˜åœ¨æ¨¡ç³Šçš„é—®é¢˜éš¾ä»¥è§£å†³ã€‚2017å¹´ï¼ŒSeungjunç­‰äººæ€»ç»“ç°æœ‰çš„å›¾åƒå»æ¨¡ç³Šç®—æ³•ä¸­å­˜åœ¨çš„é—®é¢˜ä¸ºï¼š

1. éš¾ä»¥è·å¾—å®æµ‹æ¸…æ™°å›¾åƒå’Œæ¨¡ç³Šå›¾åƒå¯¹ç”¨äºè®­ç»ƒå›¾åƒå»æ¨¡ç³Šç½‘ç»œï¼›
2. å¯¹äºåŠ¨æ€åœºæ™¯çš„å›¾åƒå»æ¨¡ç³Šé—®é¢˜ï¼Œéš¾ä»¥è·å¾—å±€éƒ¨å›¾åƒçš„æ¨¡ç³Šæ ¸ï¼›
3. å»æ¨¡ç³Šé—®é¢˜éœ€è¦è¾ƒå¤§çš„æ„Ÿå—é‡ã€‚
- é’ˆå¯¹ä¸Šè¿°æå‡ºçš„é—®é¢˜ï¼Œä½œè€…æå‡ºäº†ä¸€ç§å®æµ‹åŠ¨æ€åœºæ™¯å›¾åƒåˆæˆçš„æ–¹å¼ï¼Œå¹¶å…¬å¼€äº†ç”¨äºåŠ¨æ€åœºæ™¯çš„å›¾åƒå»æ¨¡ç³Šæ•°æ®é›†gopro_largeï¼Œ goproæ•°æ®é›†å·²ç»æˆä¸ºç›®å‰åŸºäºæ·±åº¦å­¦ä¹ çš„å»æ¨¡ç³Šç®—æ³•æœ€å¸¸ç”¨çš„æ•°æ®é›†ä¹‹ä¸€ ã€‚è€Œé’ˆå¯¹éš¾ä»¥è·å¾—åŠ¨æ€åœºæ™¯çš„å±€éƒ¨åŒºåŸŸçš„æ¨¡ç³Šæ ¸é—®é¢˜ï¼Œä½œè€…é€‰æ‹©ä¸€ç§åŸºäºæ·±åº¦å­¦ä¹ çš„ç«¯åˆ°ç«¯çš„å›¾åƒå»æ¨¡ç³Šçš„ç®—æ³•ï¼ŒæŠ›å¼ƒäº†ä¼ ç»Ÿçš„æ–¹æ³•å…ˆä¼°è®¡æ¨¡ç³Šæ ¸åœ¨ä¼°è®¡æ¸…æ™°å›¾åƒçš„ç­–ç•¥ï¼Œä½¿ç”¨å·ç§¯ç¥ç»ç½‘ç»œä»é€€åŒ–å›¾åƒä¸­ç›´æ¥å¤åŸæ¸…æ™°å›¾åƒã€‚å¹¶ä¸”ä»¿ç…§ ä¼ ç»Ÿçš„å›¾åƒå»æ¨¡ç³Šé—®é¢˜ä¸­å¤šå°ºåº¦çš„å¤åŸç­–ç•¥èå…¥åˆ°ç½‘ç»œä¸­ï¼Œç½‘ç»œè®¾è®¡å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚

<div align=center>
    <!-- ![åº”ç”¨åœºæ™¯](./img/16cvåº”ç”¨åœºæ™¯.jpg) -->
    <img src="./img/ch5/5.jpg" width="700"/>
</div>

- ä½œè€…é€šè¿‡ä¸‰ä¸ªå¤šå°ºåº¦çš„å·ç§¯ç¥ç»ç½‘ç»œï¼Œå…¶ä¸­B1ä¸ºå¾…å¤åŸå›¾åƒï¼Œåˆ†åˆ«é™é‡‡æ ·ä¸¤æ¬¡ä¸ºB2 B3ï¼Œå°†é™é‡‡æ ·çš„ç»“æœåˆ†åˆ«è¾“å…¥åˆ°ç½‘ç»œä¸­å¾—åˆ°ç›¸åº”åˆ†è¾¨ç‡å°ºå¯¸ä¸‹å¤åŸç»“æœï¼Œå¹¶å°†å¤åŸç»“æœä½œä¸ºä¸‹ä¸€é˜¶æ®µçš„è¾“å…¥ï¼Œä»è€ŒçŸ¥é“åç»­çš„å¤åŸã€‚è¿™ç§å¤šå°ºåº¦çš„ç­–ç•¥ï¼Œç±»ä¼¼äºä¼ ç»Ÿçš„æ¨¡ç³Šæ ¸ä¼°è®¡ä¸­çš„ç”±ç²—åˆ°ç»†çš„ç­–ç•¥ï¼Œå°†å¤æ‚çš„é—®é¢˜è¿›è¡Œåˆ†è§£ï¼Œé€æ­¥å¤åŸï¼Œå…ˆåœ¨ä½åˆ†è¾¨ç‡ä¸‹å¤åŸå¤§å°ºåº¦çš„ä¿¡æ¯ï¼Œç„¶åå†é«˜åˆ†è¾¨ç‡ä¸‹å¤åŸç»†èŠ‚ä¿¡æ¯ã€‚ç®€åŒ–é—®é¢˜çš„åŒæ—¶å¢å¤§äº†å›¾åƒçš„æ„Ÿå—é‡ã€‚
- ä¸æ–‡çŒ®Learning a Convolutional Neural Network for Non-uniform Motion Blur Removalå¯¹æ¯”çš„å®éªŒç»“æœå¦‚å›¾2æ‰€ç¤ºã€‚åœ¨è§†è§‰ä¸Šæå‡ºçš„æ–¹æ³•å–å¾—æ›´å¥½çš„è§†è§‰æ•ˆæœã€‚åœ¨æ•°æ®é›†GOPROä¸Šçš„æµ‹è¯•æŒ‡æ ‡å¦‚è¡¨1æ‰€ç¤ºï¼Œå¹¶å¯¹æ¯”äº†æ–¹æ³•é—´ï¼Œåœ¨ä¸åŒçš„ç½‘ç»œå°ºåº¦æ•°ä¸‹çš„å®éªŒç»“æœã€‚

<div align=center>
    <!-- ![åº”ç”¨åœºæ™¯](./img/16cvåº”ç”¨åœºæ™¯.jpg) -->
    <img src="./img/ch5/6.jpg" width="700"/>
</div>

### 3.7 åŸºäºGançš„å›¾åƒå»æ¨¡ç³Šç®—æ³•

- Ganä¸ºå¯¹æŠ—ç”Ÿæˆç½‘ç»œï¼Œé¦–æ¬¡åœ¨æ–‡çŒ®Generative Adversarial Netsä¸­è¢«æå‡ºï¼Œåº”ç”¨äºå›¾åƒç”Ÿæˆã€‚éšç€Gançš„å‘å±•é€æ­¥åº”ç”¨äºå›¾åƒå¤åŸé¢†åŸŸã€‚è¯¥æ–‡çŒ®æå‡ºå°†Ganåº”ç”¨äºå›¾åƒå»æ¨¡ç³Šé—®é¢˜ä¸Šã€‚å®ç°äº†ä¸€ç§åŸºäºæ·±åº¦å­¦ä¹ çš„ç«¯åˆ°ç«¯çš„å›¾åƒå»æ¨¡ç³Šã€‚æå‡ºçš„Gançš„ç”Ÿæˆå™¨ç½‘ç»œæ¨¡å‹å¦‚å›¾3æ‰€ç¤ºã€‚ç”Ÿæˆå™¨ç”±ä¸¤ä¸ªæ­¥é•¿ä¸º1/2çš„å·ç§¯ç½‘ç»œã€9ä¸ªResBlockå’Œä¸¤ä¸ªåå·ç§¯ç½‘ç»œç»„æˆã€‚æ¯ä¸ªResBlockåŒ…æ‹¬å·ç§¯å±‚ã€instance normalizationå±‚å’ŒReLUæ¿€æ´»å±‚ã€‚


<div align=center>
    <!-- ![åº”ç”¨åœºæ™¯](./img/16cvåº”ç”¨åœºæ™¯.jpg) -->
    <img src="./img/ch5/7.jpg" width="700"/>
</div>

<div align=center>
    <!-- ![åº”ç”¨åœºæ™¯](./img/16cvåº”ç”¨åœºæ™¯.jpg) -->
    <img src="./img/ch5/8.jpg" width="700"/>
</div>

ä¸Šå›¾ä¸º ç”Ÿæˆå™¨ç½‘ç»œç»“æ„å›¾å’ŒDeblurGanç½‘ç»œç»“æ„ç¤ºæ„å›¾





## 4. ä»»åŠ¡å®æ–½
- é€šè¿‡pythonå®ç°ä¸Šè¿°ç®—æ³•ï¼Œä½“ä¼šç®—æ³•ï¼Œåæ€æ”¹è¿›çš„æ€è·¯ï¼Œç„¶åé€šè¿‡åˆ©ç”¨æ·±åº¦å­¦ä¹ çš„ç®—æ³•æ¥å°è¯•å¢å¼ºå›¾åƒã€‚
### 4.1 å®æ–½æ€è·¯

- æ ¹æ®çŸ¥è¯†ç‚¹ä¸­æåŠåˆ°çš„æ•°å­¦å…¬å¼ï¼Œå°†å›¾åƒå¢å¼ºç®—æ³•çš„å‡½æ•°å¤ç°ï¼Œç„¶ååˆ©ç”¨å·²æœ‰å›¾ç‰‡ï¼Œè¿›è¡Œå›¾åƒå¢å¼ºã€‚

### 4.2 å®æ–½æ­¥éª¤
#### æ­¥éª¤1ï¼š
- å¯¼å…¥ç”¨åˆ°çš„ç›¸å…³æ¨¡å—:
```
%matplotlib inline

import cv2
import numpy as np
from matplotlib import pyplot as plt
```


#### æ­¥éª¤2ï¼š
- æ˜¾ç¤ºåŸå›¾:
```
#  opencv çš„æ¥å£ä½¿ç”¨BGRæ¨¡å¼ï¼Œè€Œ matplotlib.pyplot æ¥å£ä½¿ç”¨çš„æ˜¯RGBæ¨¡å¼
img = cv2.imread("img1.jpg", 1)

b, g, r = cv2.split(img)
srcImage_new = cv2.merge([r, g, b])
plt.imshow(srcImage_new)
```


#### æ­¥éª¤3ï¼š
```
# å½©è‰²å›¾åƒå‡è¡¡åŒ–,éœ€è¦åˆ†è§£é€šé“ å¯¹æ¯ä¸€ä¸ªé€šé“å‡è¡¡åŒ–
(b, g, r) = cv2.split(img)
bH = cv2.equalizeHist(b)
gH = cv2.equalizeHist(g)
rH = cv2.equalizeHist(r)
# åˆå¹¶æ¯ä¸€ä¸ªé€šé“
result = cv2.merge((rH, gH, bH))
# cv2.imshow("dst", result)

plt.imshow(result)

```

#### æ­¥éª¤4ï¼š
```
# Gammaå›¾åƒå¢å¼º
def adjust_gamma(src,gamma=2.0):
    scale = float(np.iinfo(src.dtype).max - np.iinfo(src.dtype).min)
    dst = ((src.astype(np.float32) / scale) ** gamma) * scale
    dst = np.clip(dst,0,255).astype(np.uint8)
    return dst
g_result = adjust_gamma(srcImage_new)
plt.imshow(g_result)
```

#### æ­¥éª¤5ï¼š
```
# logå¯¹æ•°å›¾åƒå¢å¼º
def log_enhance(src):
   
    scale = float(np.iinfo(src.dtype).max - np.iinfo(src.dtype).min)
    dst = np.log2(src.astype(np.float32) / scale + 1) * scale
    dst = np.clip(dst,0,255).astype(np.uint8)
    return dst
l_result = log_enhance(srcImage_new)
plt.imshow(l_result)
```

#### æ­¥éª¤6 ä½¿ç”¨æ·±åº¦æ¨¡å‹è¿›è¡Œå¢å¼ºï¼š
1. ç¯å¢ƒå’Œå‚æ•°é…ç½®

æ¥ä¸‹æ¥æˆ‘ä»¬ä»‹ç»å¦‚ä½•åˆ©ç”¨pytorchæ·±åº¦å­¦ä¹ å·¥å…·å®ç°ä¸€ä¸ªç«¯åˆ°ç«¯çš„å›¾åƒå»æ¨¡ç³Šæ¨¡å‹ï¼Œé€šè¿‡å‚æ•°è®¾ç½®ã€åŠ è½½æ•°æ®ã€æ„å»ºæ¨¡å‹ã€è®­ç»ƒæ¨¡å‹å’Œæµ‹è¯•ç”¨ä¾‹ä¾æ¬¡å®ç°ä¸€ä¸ªå›¾åƒå»æ¨¡ç³Šå·¥å…·ï¼Œåœ¨è®­ç»ƒå’Œé¢„å¤„ç†è¿‡ç¨‹ä¸­é€šè¿‡å¯è§†åŒ–ç›‘ç£è®­ç»ƒè¿‡ç¨‹ã€‚ 

æ¨¡å‹é‡‡ç”¨äº†æ®‹å·®å½¢å¼çš„CNNï¼Œè¾“å…¥å’Œè¾“å‡ºéƒ½é‡‡ç”¨é«˜æ–¯é‡‘å­—å¡”ï¼ˆGaussian pyramidï¼‰çš„å½¢å¼ã€‚æ•´ä¸ªç½‘ç»œç»“æ„ç”±ä¸‰ä¸ªç›¸ä¼¼çš„CNNæ„æˆï¼Œåˆ†åˆ«å¯¹åº”è¾“å…¥é‡‘å­—å¡”ä¸­çš„æ¯ä¸€å±‚ã€‚ç½‘ç»œæœ€å‰é¢æ˜¯åˆ†è¾¨ç‡æœ€ä½çš„å­ç½‘ç»œï¼ˆcoarest level networkï¼‰ï¼Œåœ¨è¿™ä¸ªå­ç½‘ç»œæœ€åï¼Œæ˜¯â€œupconvolution layerâ€ï¼Œå°†é‡å»ºçš„ä½åˆ†è¾¨ç‡å›¾åƒæ”¾å¤§ä¸ºé«˜åˆ†è¾¨ç‡å›¾åƒï¼Œç„¶åå’Œé«˜ä¸€å±‚çš„å­ç½‘ç»œçš„è¾“å…¥è¿æ¥åœ¨ä¸€èµ·ï¼Œä½œä¸ºä¸Šå±‚ç½‘ç»œçš„è¾“å…¥ã€‚

<div align=center>
    <!-- ![åº”ç”¨åœºæ™¯](./img/16cvåº”ç”¨åœºæ™¯.jpg) -->
    <img src="./img/ch5/9.jpg" width="700"/>
</div>

ğŸ“¦root<br>
â”£ ğŸ“‚datasetsâ€ƒâ€ƒ # å®éªŒæ‰€ç”¨æ•°æ®é›†ä¸‹è½½å¹¶è§£å‹åˆ°å½“å‰ç›®å½•<br>
â”ƒâ€ƒâ”£ ğŸ“‚trainâ€ƒ # è®­ç»ƒé›†<br>
â”ƒâ€ƒâ”— ğŸ“‚testâ€ƒ # æµ‹è¯•é›†<br>
â”£ ğŸ“‚picturesâ€ƒâ€ƒ # å­˜æ”¾ notebook ä¸­æ‰€éœ€å›¾ç‰‡<br>
â”£ ğŸ“‚resultâ€ƒâ€ƒ # å­˜æ”¾è¾“å‡ºçš„ç»“æœ<br>
â”£ ğŸ“‚modelsâ€ƒâ€ƒ # å­˜æ”¾è®­ç»ƒè¿‡ç¨‹ä¸­çš„æ–­ç‚¹å’Œè®­ç»ƒå¥½çš„æ¨¡å‹<br>
â”£ ğŸ“œå›¾åƒå»æ¨¡ç³Šåˆçº§æ¡ˆä¾‹.ipynbâ€ƒ # å½“å‰ notebook<br>
â”— ğŸ“œå›¾åƒå»æ¨¡ç³Šåˆçº§æ¡ˆä¾‹-æ ‡å‡†æäº¤ä»¶æ¸…å•.xlsxâ€ƒ # æ¡ˆä¾‹é…å¥—ææ–™è¯´æ˜æ–‡æ¡£<br>

```
# ç½‘ç»œåŸå› å¯èƒ½å®‰è£…å¤±è´¥ï¼Œè¯·å¤šè¯•å‡ æ¬¡~
# !pip install pytorch-msssim tensorboardX torchsummary tqdm 
# !pip install ipywidgets # ç”¨äºæ˜¾ç¤º notebook è¿›åº¦æ¡
# !jupyter nbextension enable --py widgetsnbextension
```

```
import os
import random

import matplotlib.pyplot as plt
import numpy as np
import pytorch_msssim # ç”¨äºè®¡ç®—æŒ‡æ ‡ ssim å’Œ mssim
import torch
import torch.nn as nn
import torch.optim as optim
from PIL import Image
from tensorboardX import SummaryWriter
from torchsummary import summary
from torch.optim import lr_scheduler
from torch.utils import data
from torchvision import transforms
from tqdm.notebook import tqdm

%matplotlib inline
```

ç”±äºæ•°æ®é›†è¾ƒå¤§ï¼Œæ¨¡å‹è¾ƒä¸ºå¤æ‚ï¼Œè™½ç„¶å·²ç»ç»è¿‡ç®€åŒ–ï¼Œä½†è®­ç»ƒæ—¶ä»ç„¶æœ‰å¾ˆå¤šå‚æ•°ï¼Œä¸ºäº†ä¾¿äºç®¡ç†å’Œä¿®æ”¹ï¼Œæœ¬æ•™ç¨‹å°†æ•´ä¸ªè¿‡ç¨‹ä¸­çš„æ‰€æœ‰å‚æ•°æ•´ç†å¦‚ä¸‹ï¼Œå…·ä½“çš„ä½¿ç”¨å°†åœ¨ä¸‹æ–‡ä¸­ä¾æ¬¡ä»‹ç»ã€‚

```
class Config():
    def __init__(self, name="Configs"):

        # train set
        self.data_dir = 'datasets/train' # è®­ç»ƒé›†ç›®å½•
        self.patch_size = 256  # è¾“å…¥æ¨¡å‹çš„ patch çš„å°ºå¯¸
        self.batch_size = 2 #16   # è®­ç»ƒæ—¶æ¯ä¸ª batch ä¸­çš„æ ·æœ¬ä¸ªæ•°
        self.n_threads = 1 #8     # ç”¨äºåŠ è½½æ•°æ®çš„çº¿ç¨‹æ•°
        # test set
        self.test_data_dir = 'datasets/test' # æµ‹è¯•é›†ç›®å½•
        self.test_batch_size = 1 # æµ‹è¯•æ—¶çš„ batch_size
        # model
        self.multi = True # æ¨¡å‹é‡‡ç”¨å¤šå°ºåº¦æ–¹æ³•ï¼ˆTrueï¼‰
        self.skip = True  # æ¨¡å‹é‡‡ç”¨æ»‘åŠ¨è¿æ¥æ–¹æ³•
        self.n_resblocks = 3 #9 # resblock çš„ä¸ªæ•°
        self.n_feats = 8 #64 # feature map çš„ä¸ªæ•°
        # optimization
        self.lr = 1e-4    # åˆå§‹å­¦ä¹ ç‡
        self.epochs = 1 #800 # è®­ç»ƒçš„ epoch çš„æ•°ç›®
        self.lr_step_size = 600 # é‡‡ç”¨æ­¥è¿›å­¦ä¹ ç‡ç­–ç•¥æ‰€ç”¨çš„ step_size
        self.lr_gamma = 0.1 # æ¯ lr_step_size åï¼Œå­¦ä¹ ç‡å˜ä¸º lr*lr_gamma
        # global
        self.name = name # é…ç½®çš„åç§°
        self.save_dir = 'temp/result' # ä¿å­˜è®­ç»ƒè¿‡ç¨‹ä¸­æ‰€äº§ç”Ÿæ•°æ®å¾—ç›®å½•
        self.save_cp_dir = 'temp/models' # ä¿å­˜ checkpoint çš„ç›®å½•
        self.imgs_dir = 'datasets/pictures' # æ­¤ notebook æ‰€éœ€çš„å›¾ç‰‡ç›®å½•

        if not os.path.exists(self.save_dir):
            os.mkdir(self.save_dir)
        if not os.path.exists(self.save_cp_dir):
            os.mkdir(self.save_cp_dir)


args = Config(name="image-deblurring")
```

#### æ­¥éª¤7 æ•°æ®å‡†å¤‡ï¼š
å› ä¸ºæœ¬æ•™ç¨‹æ‰€ä½¿ç”¨çš„çš„æ¨¡å‹åŒ…å«æœ‰å¤šå°ºåº¦å› ç´ ï¼Œæ‰€ä»¥éœ€è¦å¯¹æ•°æ®è¿›è¡Œä¸‹é‡‡æ ·ï¼Œå¹¶ä¸”è€ƒè™‘åˆ°æ•°æ®é›†å›¾ç‰‡è¾ƒå¤§ï¼Œä¸ºäº†å‡å°å¼€é”€ï¼Œé‡‡ç”¨ patch-based çš„æ–¹æ³•ï¼Œå¹¶ç”¨æ•°æ®å¢å¼ºæ¥é˜²æ­¢è¿‡æ‹Ÿåˆã€‚è¿™é‡Œçš„ patch-based æŒ‡å¯¹æ¯ä¸€ä¸ªè¾“å…¥å›¾åƒè¿›è¡Œéšæœºè£å‰ªï¼Œå¾—åˆ° path_size å¤§å°çš„å›¾ç‰‡ï¼Œç„¶åå†è¾“å…¥æ¨¡å‹è¿›è¡Œè®­ç»ƒï¼Œè¯¦ç»†è§£é‡Šè§æ­¤æ–‡ã€‚
- è¯¥å°èŠ‚æ•´ä¸ªæ•°æ®å‡†å¤‡çš„æµç¨‹å¯ä»¥åˆ†ä¸ºï¼š
1. æ•°æ®é›†å±•ç¤º
2. æ•°æ®å¢å¼º
3. æ„é€  dataset ç±»
4. æ•°æ®åŠ è½½ dataloader 

##### æ•°æ®å±•ç¤º

é€šè¿‡ 0.1 å°èŠ‚ä¸­ç»™çš„é“¾æ¥ï¼Œå°†æ•°æ®é›† GOPRO ä¸‹è½½å¹¶è§£å‹åˆ° dataset æ ¹ç›®å½•ä¸‹ï¼Œæœ€ç»ˆæ•°æ®é›†ç›®å½•å¦‚ 0.2 å°èŠ‚æ‰€ç¤ºã€‚
è¯»å–æ•°æ®é›†ä¸­çš„æŸä¸ªæ ·æœ¬ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ä¸ºäº†æ–¹ä¾¿è‡ªç”±ä¿®æ”¹æŸ¥çœ‹ï¼Œå°†è·¯å¾„æ‹†åˆ†ä¸ºå¤šä¸ªéƒ¨åˆ†ã€‚

```
sample_idx = 1 # æ ·æœ¬ç¼–å·
blur_path = os.path.join(args.imgs_dir, f"blur/test{sample_idx}.png") # æ¨¡ç³Šå›¾ç‰‡
sharp_path = os.path.join(args.imgs_dir, f"sharp/test{sample_idx}.png") # å»æ¨¡ç³Šå›¾ç‰‡
blur_img = plt.imread(blur_path)
sharp_img = plt.imread(sharp_path)
```

```
# å¯è§†åŒ–å›¾ç‰‡å¦‚ä¸‹å›¾æ‰€ç¤º
plt.figure(figsize=(10,4))
plt.subplot(121);plt.imshow(blur_img);
plt.subplot(122);plt.imshow(sharp_img);
plt.show()
```
å·¦è¾¹ä¸ºæ¨¡ç³Šçš„å›¾ç‰‡ï¼Œå…¶å…·ä½“äº§ç”Ÿæ–¹æ³•ä¸ºï¼šä½¿ç”¨äº†ä¸€ä¸ªé«˜é€Ÿæ‘„åƒå¤´å¿«é€Ÿè®°å½•ä¸‹ä¸€è¿ä¸²æ¸…æ™°å›¾åƒï¼Œç„¶åå°†è¿™äº›é—´éš”æ—¶é—´éå¸¸çŸ­çš„æ¸…æ™°å›¾åƒæ±‚å¹³å‡æ¥è·å¾—æ¨¡ç³Šå›¾åƒã€‚å³è¾¹ä¸ºæ¸…æ™°çš„å›¾åƒã€‚

##### æ•°æ®å¢å¼º

ä¸ºäº†é˜²æ­¢è¿‡æ‹Ÿåˆï¼Œéœ€è¦å¯¹æ•°æ®é›†è¿›è¡Œæ•°æ®å¢å¼ºï¼Œå¢å¼ºæ–¹å¼å¦‚ä¸‹æ‰€ç¤ºï¼Œå¯¹æ¯ä¸€ä¸ªè¾“å…¥å›¾åƒï¼Œéƒ½å°†å…¶è¿›è¡Œéšæœºè§’åº¦æ—‹è½¬ï¼Œæ—‹è½¬çš„è§’åº¦åœ¨ [0, 90, 180, 270] ä¸­éšæœºé€‰å–ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œè€ƒè™‘åˆ°å›¾åƒè´¨é‡ä¸‹é™ï¼Œå¯¹ HSV é¢œè‰²ç©ºé—´çš„é¥±å’Œåº¦ä¹˜ä»¥ 0.8 åˆ° 1.2 å†…çš„éšæœºæ•°ã€‚

```
def augment(img_input, img_target):
    degree = random.choice([0, 90, 180, 270])
    img_input = transforms.functional.rotate(img_input, degree)
    img_target = transforms.functional.rotate(img_target, degree)

    # color augmentation
    img_input = transforms.functional.adjust_gamma(img_input, 1)
    img_target = transforms.functional.adjust_gamma(img_target, 1)
    sat_factor = 1 + (0.2 - 0.4 * np.random.rand())
    img_input = transforms.functional.adjust_saturation(img_input, sat_factor)
    img_target = transforms.functional.adjust_saturation(img_target, sat_factor)

    return img_input, img_target
```
ç”¨ Image æ¨¡å—çš„ open è¯»å–å›¾ç‰‡ï¼Œå¹¶å±•ç¤ºå¢å¼ºåçš„ç»“æœã€‚

```
img_input = Image.open(blur_path)
img_target = Image.open(sharp_path)
img_aug_input,img_aug_target = augment(img_input,img_target)

plt.figure(figsize=(10,5))
plt.subplot(121);plt.imshow(img_aug_input)
plt.subplot(122);plt.imshow(img_aug_target)
plt.show()
```

##### æ„é€ datasetç±»

å¦‚ä¹‹å‰æ‰€è¯´ï¼Œå¯¹äºæ¯ä¸€ä¸ªè¾“å…¥å›¾åƒï¼Œå¯¹é½è¿›è¡Œéšæœºè£å‰ªï¼Œå¾—åˆ° path_size å¤§å°çš„è¾“å…¥ï¼Œå…·ä½“ä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚

```
def getPatch(img_input, img_target, path_size):
    w, h = img_input.size
    p = path_size
    x = random.randrange(0, w - p + 1)
    y = random.randrange(0, h - p + 1)
    img_input = img_input.crop((x, y, x + p, y + p))
    img_target = img_target.crop((x, y, x + p, y + p))
    return img_input, img_target
```

æ„é€ ä¸€ä¸ª dataset ç±»ï¼Œç»§æ‰¿äº torch.utils.data.Datasetï¼Œæˆ‘ä»¬åªéœ€è¦é‡å†™ä»–çš„åˆå§‹åŒ–å‡½æ•° __init__ï¼Œè¿”å›æ•°æ®é›†é•¿åº¦çš„å‡½æ•° __len__ï¼Œä»¥åŠå¦‚ä½•è¯»å–æ¯ä¸€ä¸ªæ ·æœ¬çš„ __getitem__ã€‚

- __len__ ï¼šè¾ƒä¸ºç®€å•ï¼Œåªéœ€è°ƒç”¨ len() æ¥è·å–æ•°æ®é›†é•¿åº¦å³å¯
- __init__ : å®šä¹‰ä¸€äº›åŸºæœ¬å‚æ•°ï¼Œå¦‚å›¾ç‰‡çš„æ ¹ç›®å½•ç­‰ï¼Œéœ€è¦ä¸ __getitem__ ä¸€èµ·é…åˆå®Œæˆæ•°æ®çš„è¯»å–
- __getitem__ : æ¥å— int ç±»å‹çš„å‚æ•° indexï¼Œå³æƒ³è¦è¯»å–çš„æ ·æœ¬çš„ç´¢å¼•ï¼Œæ ¹æ®ç´¢å¼•è¿”å›è¯¥æ ·æœ¬ã€‚- 

```
class Gopro(data.Dataset):
    def __init__(self, data_dir, patch_size=256, is_train=False, multi=True):
        super(Gopro, self).__init__()
        self.is_train = is_train # æ˜¯å¦æ˜¯è®­ç»ƒé›†
        self.patch_size = patch_size # è®­ç»ƒæ—¶ patch çš„å°ºå¯¸
        self.multi = multi # æ˜¯å¦é‡‡ç”¨å¤šå°ºåº¦å› å­ï¼Œé»˜è®¤é‡‡ç”¨

        self.sharp_file_paths = []
        sub_folders = os.listdir(data_dir)

        for folder_name in sub_folders:
            sharp_sub_folder = os.path.join(data_dir, folder_name, 'sharp')
            sharp_file_names = os.listdir(sharp_sub_folder)

            for file_name in sharp_file_names:
                sharp_file_path = os.path.join(sharp_sub_folder, file_name)
                self.sharp_file_paths.append(sharp_file_path)

        self.n_samples = len(self.sharp_file_paths)

    def get_img_pair(self, idx):
        sharp_file_path = self.sharp_file_paths[idx]
        blur_file_path = sharp_file_path.replace("sharp", "blur")

        img_input = Image.open(blur_file_path).convert('RGB')
        img_target = Image.open(sharp_file_path).convert('RGB')

        return img_input, img_target

    def __getitem__(self, idx):
        img_input, img_target = self.get_img_pair(idx)

        if self.is_train:
            img_input, img_target = getPatch(img_input, img_target,
                                             self.patch_size)
            img_input, img_target = augment(img_input, img_target)
        # è½¬åŒ–ä¸º tensor ç±»å‹
        input_b1 = transforms.ToTensor()(img_input)
        target_s1 = transforms.ToTensor()(img_target)

        H = input_b1.size()[1]
        W = input_b1.size()[2]

        if self.multi:
            input_b1 = transforms.ToPILImage()(input_b1)
            target_s1 = transforms.ToPILImage()(target_s1)

            input_b2 = transforms.ToTensor()(transforms.Resize([int(H / 2), int(W / 2)])(input_b1))
            input_b3 = transforms.ToTensor()(transforms.Resize([int(H / 4), int(W / 4)])(input_b1))
            # åªå¯¹è®­ç»ƒé›†è¿›è¡Œæ•°æ®å¢å¼º
            if self.is_train:
                target_s2 = transforms.ToTensor()(transforms.Resize([int(H / 2), int(W / 2)])(target_s1))
                target_s3 = transforms.ToTensor()(transforms.Resize([int(H / 4), int(W / 4)])(target_s1))
            else:
                target_s2 = []
                target_s3 = []

            input_b1 = transforms.ToTensor()(input_b1)
            target_s1 = transforms.ToTensor()(target_s1)
            return {
                'input_b1': input_b1, # å‚ç…§ä¸‹æ–‡çš„ç½‘ç»œç»“æ„ï¼Œè¾“å…¥å›¾åƒçš„å°ºåº¦ 1
                'input_b2': input_b2, # è¾“å…¥å›¾åƒçš„å°ºåº¦ 2
                'input_b3': input_b3, # è¾“å…¥å›¾åƒçš„å°ºåº¦ 3
                'target_s1': target_s1, # ç›®æ ‡å›¾åƒçš„å°ºåº¦ 1
                'target_s2': target_s2, # ç›®æ ‡å›¾åƒçš„å°ºåº¦ 2
                'target_s3': target_s3 # ç›®æ ‡å›¾åƒçš„å°ºåº¦ 3
            }
        else:
            return {'input_b1': input_b1, 'target_s1': target_s1}

    def __len__(self):
        return self.n_samples
```

##### æ•°æ®åŠ è½½ dataloader
æ ¹æ®å‰é¢å®šä¹‰å¥½çš„ç±» Gopro æ¥æ„é€ ä¸€ä¸ª dataloaderï¼Œè®­ç»ƒæ—¶é€šè¿‡è¿­ä»£ dataloader æ¥è·å–æ•°æ®ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡dataloader æ¥å®ç°ä¸€äº›åŸºç¡€åŠŸèƒ½ï¼Œå¦‚å°†æ•°æ®é›†æ‰“ä¹±ï¼ˆshuffle=Trueï¼‰ï¼Œè®¾ç½®batch_sizeï¼Œå¤šçº¿ç¨‹åŠ è½½æ•°æ®ï¼ˆnum_workersï¼‰ç­‰ã€‚

```
def get_dataset(data_dir, patch_size=None, batch_size=1, 
                n_threads=1, is_train=False, multi=False):
    # Dataset å®ä¾‹åŒ–
    dataset = Gopro(data_dir, patch_size=patch_size, 
                    is_train=is_train, multi=multi)
    # åˆ©ç”¨å°è£…å¥½çš„ dataloader æ¥å£å®šä¹‰è®­ç»ƒè¿‡ç¨‹ä¸­çš„è¿­ä»£å™¨
    dataloader = torch.utils.data.DataLoader(dataset, batch_size=batch_size,
                                             drop_last=True, shuffle=is_train,
                                             num_workers=int(n_threads))
    return dataloader
```

å°†è®­ç»ƒæ—¶çš„ dataloader å®ä¾‹åŒ–

```
data_loader = get_dataset(args.data_dir,
                          patch_size=args.patch_size,
                          batch_size=args.batch_size,
                          n_threads=args.n_threads,
                          is_train=True,
                          multi=args.multi)
```

#### æ­¥éª¤8 æ¨¡å‹æ„å»ºï¼š
æœ¬å°èŠ‚é€šè¿‡ pytorch çš„ä¸€äº›å†…ç½®å‡½æ•°ï¼Œæ­å»ºäº†è®ºæ–‡ä¸­çš„æ¨¡å‹ï¼Œå…·ä½“åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ï¼š
1. æ¨¡å‹ä»‹ç»
2. æ¨¡å‹å®šä¹‰
3. å®ä¾‹åŒ–æ¨¡å‹
4. æŸå¤±å‡½æ•°å’Œä¼˜åŒ–å™¨

##### æ¨¡å‹ä»‹ç»
æˆ‘ä»¬å°†é‡‡ç”¨3.6ä¸­æåˆ°çš„æ¨¡å‹æ¶æ„
å›¾ä¸­ CONV è¡¨ç¤ºå·ç§¯å±‚ï¼ŒResBlock è¡¨ç¤ºæ®‹å·®æ¨¡å—ï¼ŒUpconv è¡¨ç¤ºä¸Šé‡‡æ ·ï¼ˆä¹Ÿå¯ä»¥ç”¨åå·ç§¯ä»£æ›¿ï¼‰ã€‚ä»å›¾ä¸­å¯ä»¥çœ‹å‡ºï¼Œè¯¥æ¨¡å‹ä½¿ç”¨äº† â€œmulti-scaleâ€ çš„ç»“æ„ï¼Œåœ¨è¾“å…¥å’Œè¾“å‡ºéƒ¨åˆ†éƒ½éƒ½é‡‡ç”¨äº†é«˜æ–¯é‡‘å­—å¡”ï¼ˆGaussian pyramidï¼‰çš„å½¢å¼ï¼ˆå³å¯¹åŸå›¾åƒè¿›è¡Œä¸åŒå°ºåº¦çš„ä¸‹é‡‡æ ·ï¼Œä»è€Œè·å¾—å¤„äºä¸åŒåˆ†è¾¨ç‡çš„å›¾åƒï¼‰ã€‚

<div align=center>
    <!-- ![åº”ç”¨åœºæ™¯](./img/16cvåº”ç”¨åœºæ™¯.jpg) -->
    <img src="./img/ch5/10.jpg" width="400"/>
</div>

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œ(a) æ˜¯å¸¸è§çš„æ®‹å·®æ¨¡å—ï¼Œï¼ˆbï¼‰æ˜¯æœ¬æ–‡æ‰€é‡‡ç”¨çš„æ®‹å·®æ¨¡å—ã€‚
æœ¬æ–‡ä¸­çš„æ®‹å·®æ¨¡å—å»é™¤äº† Batch Normalizationï¼ˆBNï¼‰ å±‚ï¼Œè¿™æ˜¯å› ä¸ºè®­ç»ƒæ—¶batch sizeè¾ƒå°ï¼Œå»é™¤BNå±‚å¯ä»¥åŠ é€Ÿè®­ç»ƒé€Ÿåº¦ã€‚åŒæ—¶ä¸ºäº†åŠ å¿«è®­ç»ƒæ—¶çš„æ”¶æ•›é€Ÿåº¦ï¼Œæœ€åä¸€å±‚çš„éçº¿æ€§å•å…ƒ ReLU ä¹Ÿè¢«å»é™¤ã€‚
ç”¨è¿™ç§æ®‹å·®å½¢å¼çš„ CNN çš„æ¥æ­å»ºæ¨¡å‹ï¼Œå…·ä½“åŸå› æ˜¯ï¼š<br>
ï¼ˆ1ï¼‰èƒ½æ„å»ºæ›´æ·±çš„ç½‘ç»œï¼Œå¢å¤§æ„Ÿå—é‡ã€‚<br>
ï¼ˆ2ï¼‰æ¨¡ç³Šå›¾åƒå’Œæ¸…æ™°å›¾åƒåœ¨æ•°å€¼ä¸Šæœ¬èº«å°±æ¯”è¾ƒç›¸è¿‘ï¼Œå› æ­¤æ®‹å·®æ›´æœ‰åˆ©äºæ¨¡å‹å­¦ä¹ ã€‚<br>

##### æ¨¡å‹å®šä¹‰
é€šè¿‡ pytorch çš„å†…ç½®æ¥å£ï¼Œæ­å»ºæ¨¡å‹ç»“æ„å¦‚ä¸‹æ‰€ç¤ºã€‚
å…¶ä¸­ default_conv æ˜¯æ¨¡å‹é‡‡ç”¨çš„é»˜è®¤å·ç§¯å±‚ï¼ŒUpConv ç”¨äºä¸Šé‡‡æ ·å·ç§¯ï¼ŒResidualBlock æ˜¯æ¨¡å‹ä½¿ç”¨çš„æ®‹å·®æ¨¡å—ï¼ŒSingleScaleNet æ˜¯å•ä¸ªå°ºåº¦ç½‘ç»œï¼ŒMultiScaleNet å°†å‡ ä¸ª SingleScaleNet æ•´åˆæˆäº†æœ€ç»ˆçš„å¤šå°ºåº¦ç½‘ç»œæ¨¡å‹ã€‚
å…·ä½“çš„å„ä¸ªå‡½æ•°çš„ä½œç”¨å¦‚ä¸‹ï¼š

- default_conv : ç½‘ç»œä¸­é»˜è®¤é‡‡ç”¨çš„å·ç§¯å±‚ï¼Œå®šä¹‰ä¹‹åï¼Œé¿å…é‡å¤ä»£ç 
- UpConv : ä¸Šå·ç§¯ï¼Œå¯¹åº”ä¸Šå›¾ä¸­çš„ Up Convï¼Œå°†å›¾åƒçš„å°ºåº¦æ‰©å¤§ï¼Œè¾“å…¥åˆ°å¦ä¸€ä¸ªå•å°ºåº¦ç½‘ç»œ
- ResidualBlock : æ®‹å·®æ¨¡å—ï¼Œç½‘ç»œæ¨¡å‹ä¸­é‡‡ç”¨çš„æ®‹å·®æ¨¡å—ï¼Œä¹‹æ‰€ä»¥é‡‡ç”¨æ®‹å·®æ¨¡å—ï¼Œæ˜¯å› ä¸ºç½‘ç»œâ€œåªéœ€è¦éœ€è¦æ¨¡ç³Šå›¾åƒä¸å»æ¨¡ç³Šå›¾åƒä¹‹é—´çš„å·®å¼‚å³å¯â€
- SingleScaleNet : å•å°ºåº¦æ¨¡å‹ï¼Œä¸€ä¸ªå°ºåº¦å¯¹åº”ä¸€ä¸ªå•å°ºåº¦æ¨¡å‹å®ä¾‹
- MultiScaleNet : å¤šå°ºåº¦æ¨¡å‹ï¼Œå°†å¤šä¸ªå•å°ºåº¦æ¨¡å‹å®ä¾‹ç»„åˆå³å¯å¾—åˆ°ä¸Šå›¾æ‰€ç¤ºçš„å¤šå°ºåº¦å»æ¨¡ç³Šç½‘ç»œ

```
def default_conv(in_channels, out_channels, kernel_size, bias):
    return nn.Conv2d(in_channels,
                     out_channels,
                     kernel_size,
                     padding=(kernel_size // 2),
                     bias=bias)
                
class UpConv(nn.Module):
    def __init__(self):
        super(UpConv, self).__init__()
        self.body = nn.Sequential(default_conv(3, 12, 3, True),
                                  nn.PixelShuffle(2), nn.ReLU(inplace=True))

    def forward(self, x):
        return self.body(x)

class ResidualBlock(nn.Module):
    def __init__(self, n_feats):
        super(ResidualBlock, self).__init__()
        modules_body = [
            default_conv(n_feats, n_feats, 3, bias=True),
            nn.ReLU(inplace=True),
            default_conv(n_feats, n_feats, 3, bias=True)
        ]
        self.body = nn.Sequential(*modules_body)

    def forward(self, x):
        res = self.body(x)
        res += x
        return res

class SingleScaleNet(nn.Module):
    def __init__(self, n_feats, n_resblocks, is_skip, n_channels=3):
        super(SingleScaleNet, self).__init__()
        self.is_skip = is_skip

        modules_head = [
            default_conv(n_channels, n_feats, 5, bias=True),
            nn.ReLU(inplace=True)
        ]

        modules_body = [ResidualBlock(n_feats) for _ in range(n_resblocks)]

        modules_tail = [default_conv(n_feats, 3, 5, bias=True)]

        self.head = nn.Sequential(*modules_head)
        self.body = nn.Sequential(*modules_body)
        self.tail = nn.Sequential(*modules_tail)

class MultiScaleNet(nn.Module):
    def __init__(self, n_feats, n_resblocks, is_skip):
        super(MultiScaleNet, self).__init__()

        self.scale3_net = SingleScaleNet(n_feats,
                                         n_resblocks,
                                         is_skip,
                                         n_channels=3)
        self.upconv3 = UpConv()

        self.scale2_net = SingleScaleNet(n_feats,
                                         n_resblocks,
                                         is_skip,
                                         n_channels=6)
        self.upconv2 = UpConv()

        self.scale1_net = SingleScaleNet(n_feats,
                                         n_resblocks,
                                         is_skip,
                                         n_channels=6)

    def forward(self, mulscale_input):
        input_b1, input_b2, input_b3 = mulscale_input

        output_l3 = self.scale3_net(input_b3)
        output_l3_up = self.upconv3(output_l3)

        output_l2 = self.scale2_net(torch.cat((input_b2, output_l3_up), 1))
        output_l2_up = self.upconv2(output_l2)

        output_l1 = self.scale2_net(torch.cat((input_b1, output_l2_up), 1))

        return output_l1, output_l2, output_l3
```

##### æ¨¡å‹å®ä¾‹åŒ–

æ¨¡å‹é€‰å–ï¼Œæ ¹æ®å‰é¢å‚æ•°ä¸­çš„ n_featsã€n_resblocksã€skip å’Œ multi æ¥å¯¹æ¨¡å‹è¿›è¡Œå®ä¾‹åŒ–ã€‚
```
if args.multi:
    my_model = MultiScaleNet(n_feats=args.n_feats,
                             n_resblocks=args.n_resblocks,
                             is_skip=args.skip)
else:
    my_model = SingleScaleNet(n_feats=args.n_feats,
                              n_resblocks=args.n_resblocks,
                              is_skip=args.skip)
# my_model = my_model.cuda()
```
å¯¹å®ä¾‹åŒ–åçš„æ¨¡å‹çš„ç»“æ„è¿›è¡Œåˆ†æï¼Œç»“æœå¦‚ä¸‹æ‰€ç¤º:
```
print (my_model)
```

##### æŸå¤±å‡½æ•°å’Œä¼˜åŒ–å™¨
åœ¨è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ Adam ä¼˜åŒ–å™¨ï¼Œåˆå§‹å­¦ä¹ ç‡ä¸º lrï¼Œå…¶ç›¸å¯¹äº SGDï¼Œæ›´è‡ªåŠ¨åŒ–ï¼Œå®é™…ä¸­éœ€è¦è°ƒæ•´çš„å‚æ•°è¾ƒå°‘ï¼Œä½†éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå…¶ä½¿ç”¨å†…å­˜ä¹Ÿæ¯” SGD è¦é«˜ã€‚
æŸå¤±å‡½æ•°ä½¿ç”¨æœ€å¸¸è§çš„å‡æ–¹æŸå¤±å‡½æ•°ï¼ˆMSELossï¼‰:
$$
M S E=\frac{1}{M \times N \sum_{i=1}^{M} \sum_{j=1}^{N}\left(f^{\prime}(i, j)-f(i, j)\right)^{2}}
â€‹$$


å…¶ä¸­ $f^{\prime}(i,j)$ å’Œ $f(i,j)$ åˆ†åˆ«ä¸ºæ¨¡å‹è¾“å‡ºç»“æœå›¾å’Œéæ¨¡ç³Šå›¾ä¸Šåæ ‡ä¸º (i,j)(i,j)(i,j) çš„åƒç´ ï¼ŒM,Nåˆ†åˆ«è¡¨ç¤ºå›¾ç‰‡çš„é•¿ä¸å®½ã€‚
å…·ä½“çš„ï¼Œæœ¬æ–‡æ‰€ç”¨çš„å¤šå°ºåº¦æŸå¤±å‡½æ•°ä¸ºï¼š
$$
{L}=\frac{1}{K} \sum_{k=1}^{K} M S E (f^{\prime}_k, f_k)
$$
$f^{\prime}_k$â€‹ å’Œ $f_k$â€‹åˆ†åˆ«è¡¨ç¤ºç¬¬ k ä¸ªå°ºåº¦ä¸Šçš„è¾“å‡ºç»“æœå›¾å’Œéæ¨¡ç³Šå›¾ã€‚
åœ¨ pytorch ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥è°ƒç”¨å®šä¹‰å¥½çš„æ¥å£æ¥å®ç°åŸºç¡€çš„MSEã€‚
ï¼ˆMSE çš„å®˜æ–¹æ–‡æ¡£ å’Œ Adam çš„å®˜æ–¹æ–‡æ¡£ï¼‰

```
# loss_function = nn.MSELoss().cuda()
loss_function = nn.MSELoss()
optimizer = optim.Adam(my_model.parameters(), lr=args.lr)
```

#### æ­¥éª¤9 æ¨¡å‹è®­ç»ƒï¼š

æœ¬å°èŠ‚ä¸ºæ¨¡å‹çš„è®­ç»ƒè¿‡ç¨‹ä»‹ç»ï¼Œå…·ä½“åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ï¼š
1. è®­ç»ƒç­–ç•¥
2. è®­ç»ƒæ¨¡å‹
3. è®­ç»ƒè¿‡ç¨‹å¯è§†åŒ–

##### è®­ç»ƒç­–ç•¥
åœ¨æ¨¡å‹è®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œéšç€è®­ç»ƒçš„è¿›è¡Œï¼Œæ›´æ–°ç½‘ç»œå‚æ•°çš„æ­¥è¿›ï¼ˆå­¦ä¹ ç‡ï¼‰åº”è¯¥è¶Šæ¥è¶Šå°ï¼Œæ•´ä½“è®­ç»ƒè¿‡ç¨‹åº”è¯¥æ»¡è¶³ â€œå…ˆç²—è°ƒåç»†è°ƒâ€ï¼Œè¿™å°±æ˜¯å¸¸è¯´çš„å­¦ä¹ ç‡ç­–ç•¥ã€‚
æœ¬æ¬¡è®­ç»ƒé‡‡ç”¨çš„å­¦ä¹ ç‡ä¼˜åŒ–ç­–ç•¥ä¸º lr_scheduler.StepLRï¼Œæ­¥è¿›ä¸º lr_step_sizeï¼Œå­¦ä¹ ç‡æ¯éš” lr_step_size ä¸ª epoch ä¹˜ä»¥ lr_gammaã€‚
åŒæ ·å¯ä»¥ç›´æ¥è°ƒç”¨ pytorch çš„æ¥å£æ¥å®ç°ã€‚

##### è®­ç»ƒæ¨¡å‹
åœ¨è®­ç»ƒå¼€å§‹ä¹‹å‰ï¼Œè¦å…ˆåˆ›å»ºä¸€ä¸ª SummaryWriterï¼Œç”¨æ¥è®°å½•å’Œå¯è§†åŒ–è®­ç»ƒè¿‡ç¨‹ã€‚

```
writer = SummaryWriter(os.path.join(args.save_dir, "temp/logs/"))
```

åœ¨å‘½ä»¤è¡Œè¿è¡Œ tensorboard --logdir=experiment/logs æ¥å¯åŠ¨tensorboardã€‚
åœ¨è®­ç»ƒæ¨¡å‹æ—¶ï¼Œæ¯è®­ç»ƒå®Œä¸€ä¸ª epoch å°†æ¨¡å‹çš„å‚æ•°ä¿å­˜ä¸‹æ¥ï¼Œé˜²æ­¢è®­ç»ƒè¢«æ„å¤–ä¸­æ–­ä»¥åŠæ–¹ä¾¿æµ‹è¯•ï¼Œå¦‚æœéœ€è¦ä¸æ–­æ›´æ–°æœ€æ–°çš„ä¸€æ¬¡è®­ç»ƒçš„å‚æ•°ï¼Œå¯ä»¥å–æ¶ˆæœ€åä¸€è¡Œçš„æ³¨é‡Šã€‚è®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œä½¿ç”¨ tqdm çš„è¿›åº¦æ¡æ¥è§‚å¯Ÿè®­ç»ƒè¿‡ç¨‹ï¼Œå¦‚æœè¿›åº¦æ¡æ— æ³•æ­£å¸¸æ˜¾ç¤ºï¼Œå¯ä»¥å‚è€ƒè¿™é‡Œæˆ–è€…è¿™é‡Œè§£å†³ã€‚

```
bar_format = '{desc}{percentage:3.0f}% | [{elapsed}<{remaining},{rate_fmt}]' # è¿›åº¦æ¡æ ¼å¼

for epoch in range(args.epochs):
    total_loss = 0
    batch_bar = tqdm(data_loader, bar_format=bar_format) # åˆ©ç”¨tqdmåŠ¨æ€æ˜¾ç¤ºè®­ç»ƒè¿‡ç¨‹
    for batch, images in enumerate(batch_bar):
        my_model.train()
        curr_batch = epoch * data_loader.__len__() + batch # å½“å‰batchåœ¨æ•´ä¸ªè®­ç»ƒè¿‡ç¨‹ä¸­çš„ç´¢å¼•

        input_b1 = images['input_b1'] # åŸå§‹è¾“å…¥å›¾åƒ
        target_s1 = images['target_s1'] # ç›®æ ‡éæ¨¡ç³Šå›¾ç‰‡
        if args.multi:
            input_b2 = images['input_b2'] # level-2 å°ºåº¦
            target_s2 = images['target_s2']
            input_b3 = images['input_b3'] # level-3 å°ºåº¦
            target_s3 = images['target_s3']
            output_l1, output_l2, output_l3 = my_model(
                (input_b1, input_b2, input_b3))
            # æŸå¤±å‡½æ•°
            loss = (loss_function(output_l1, target_s1) +
                    loss_function(output_l2, target_s2) +
                    loss_function(output_l3, target_s3)) / 3
        else:
            output_l1 = my_model(input_b1)
            loss = loss_function(output_l1, target_s1)

        my_model.zero_grad()
        loss.backward() # åå‘ä¼ æ’­
        optimizer.step() # æ›´æ–°æƒå€¼
        total_loss += loss.item()

        print_str = " | ".join([
            "epoch:%3d/%3d" % (epoch + 1, args.epochs),
            "batch:%3d/%3d" % (batch + 1, data_loader.__len__()),
            "loss:%.5f" % (loss.item()),
        ])
        batch_bar.set_description(print_str, refresh=True) # æ›´æ–°è¿›åº¦æ¡

        writer.add_scalar('train/batch_loss', loss.item(), curr_batch)

    batch_bar.close()
    scheduler.step() # è°ƒæ•´å­¦ä¹ ç‡
    loss = total_loss / (batch + 1)
    writer.add_scalar('train/epoch_loss', loss, epoch)
    torch.save(my_model.state_dict(),os.path.join(args.save_cp_dir, f'Epoch_{epoch}.pt')) # ä¿å­˜æ¯ä¸ª epoch çš„å‚æ•°
#     torch.save(my_model.state_dict(),os.path.join(args.save_cp_dir, f'Epoch_lastest.pt')) # ä¿å­˜æœ€æ–°çš„å‚æ•°
```

##### è®­ç»ƒå¯è§†åŒ–
åœ¨tensorboardä¸­å¯ä»¥è§‚å¯Ÿè®­ç»ƒè¿‡ç¨‹çš„losså˜åŒ–è¿‡ç¨‹ã€‚


### æ­¥éª¤10 æ¨¡å‹è¯„ä¼°ï¼š
ä¸ºäº†å¯¹æ¨¡å‹è¿›è¡Œæœ‰æ•ˆçš„è¯„ä¼°ï¼Œç»™å‡ºäº†å›¾åƒå»æ¨¡ç³Šå¸¸ç”¨çš„ä¸‰ä¸ªæŒ‡æ ‡ï¼Œå¹¶å¯¹å…¶è¿›è¡Œäº†ä»‹ç»ä¸å®ç°ï¼š
1. æŒ‡æ ‡ä»‹ç»
2. æŒ‡æ ‡å®ç°

##### æŒ‡æ ‡ä»‹ç»
ä¸ºäº†è¯„ä¼°æ¨¡å‹çš„æ•ˆæœå¦‚ä½•ï¼Œæˆ‘ä»¬é€šè¿‡è®¡ç®—å³°å€¼ä¿¡å™ªæ¯”ï¼ˆPeak Signal-to-Noise Ratio, PSNRï¼‰ï¼Œç»“æ„ç›¸ä¼¼æ€§ï¼ˆStructural Similarity, SSIMï¼‰å’Œå¤šå°ºåº¦çš„ SSIMï¼ˆMulti-Scale SSIMï¼ŒMSSIMï¼‰ä¸‰ä¸ªæŒ‡æ ‡æ¥å¯¹ç»“æœè¿›è¡Œåˆ†æã€‚ï¼š
- PSNR

PSNR çš„å®šä¹‰å¦‚ä¸‹ï¼š
$$
PSNR=10 \cdot \log _{10}\left(\frac{M A X_{I}^{2}}{M S E}\right)=20 \cdot \log _{20}\left(\frac{M A X_{I}}{\sqrt{M S E}}\right)
$$
å…¶ä¸­ï¼Œ$M A X_{I}$â€‹è¡¨ç¤ºå›¾åƒç‚¹é¢œè‰²çš„æœ€å¤§æ•°å€¼ï¼Œå¦‚æœæ¯ä¸ªé‡‡æ ·ç‚¹ç”¨ 8 ä½è¡¨ç¤ºï¼Œåˆ™æœ€å¤§æ•°å€¼ä¸º 255ï¼ŒMSEæ˜¯ä¸¤ä¸ªå›¾åƒä¹‹é—´çš„å‡æ–¹è¯¯å·®ã€‚
PSNRå€¼è¶Šå¤§ä»£è¡¨æ¨¡ç³Šå›¾åƒä¸å‚è€ƒå›¾åƒè¶Šæ¥è¿‘ï¼Œå³å»æ¨¡ç³Šæ•ˆæœè¶Šå¥½ã€‚

- SSIM

SSIMä¹Ÿæ˜¯è¡¡é‡ä¸¤å¹…å›¾ç‰‡ç›¸ä¼¼æ€§çš„æŒ‡æ ‡ï¼Œå…¶å®šä¹‰å¦‚ä¸‹ï¼š
$$
{SSIM}(\mathbf{x}, \mathbf{y})=[l(\mathbf{x}, \mathbf{y})]^{\alpha}[c(\mathbf{x}, \mathbf{y})]^{\beta}[s(\mathbf{x}, \mathbf{y})]^{\gamma}
$$

SSIMç”±æ¨¡å‹è¾“å‡ºå›¾åƒ x å’Œå‚è€ƒå›¾åƒ y ä¹‹é—´çš„äº®åº¦å¯¹æ¯”ï¼ˆ$l(\mathbf{x}, \mathbf{y})$ï¼‰ã€å¯¹æ¯”åº¦å¯¹æ¯”ï¼ˆ$c(\mathbf{x}, \mathbf{y})
$ï¼‰å’Œç»“æ„å¯¹æ¯”ï¼ˆ$s(\mathbf{x}, \mathbf{y})$ï¼‰ä¸‰éƒ¨åˆ†ç»„æˆï¼Œ$\alpha$ï¼Œ$\beta$ å’Œ $\gamma$æ˜¯å„è‡ªçš„æƒé‡å› å­ï¼Œä¸€èˆ¬éƒ½å–ä¸º 1ï¼š
$$
\begin{aligned} l(\mathbf{x}, \mathbf{y})=& \frac{2 \mu_{x} \mu_{y}+C_{1}}{\mu_{x}^{2}+\mu_{y}^{2}+C_{1}} \\ c(\mathbf{x}, \mathbf{y})=& \frac{2 \sigma_{x} \sigma_{y}+C_{2}}{\sigma_{x}^{2}+\sigma_{y}^{2}+C_{2}} \\ s(\mathbf{x}, \mathbf{y}) &=\frac{\sigma_{x y}+C_{3}}{\sigma_{x} \sigma_{y}+C_{3}} \end{aligned}
$$

å…¶ä¸­ï¼Œ$C_{1}â€‹$ï¼Œ$C_{2}$å’Œ$C_{3}â€‹$ä¸ºå¸¸æ•°ï¼Œæ˜¯ä¸ºäº†é¿å…åˆ†æ¯æ¥è¿‘äº0æ—¶é€ æˆçš„ä¸ç¨³å®šæ€§ã€‚$\mu_{x}$â€‹ å’Œ $\mu_{y}$â€‹ åˆ†åˆ«ä¸ºæ¨¡å‹è¾“å‡ºå›¾åƒå’Œå‚è€ƒå›¾åƒçš„å‡å€¼ã€‚$\sigma_{x}$â€‹ å’Œ $\sigma_{y}$ åˆ†åˆ«ä¸ºæ¨¡å‹è¾“å‡ºå›¾åƒå’Œå‚è€ƒå›¾åƒçš„æ ‡å‡†å·®ã€‚é€šå¸¸å– $C1=(K1*L)^2ï¼ŒC2=(K2*L)^2ï¼ŒC3=C2/2$ï¼Œä¸€èˆ¬åœ°K1=0.01ï¼Œ K2=0.03, L=255ï¼ˆ Læ˜¯åƒç´ å€¼çš„åŠ¨æ€èŒƒå›´ï¼Œä¸€èˆ¬éƒ½å–ä¸º255ï¼‰ã€‚
è¾“å‡ºå›¾ç‰‡å’Œç›®æ ‡å›¾ç‰‡çš„ç»“æ„ç›¸ä¼¼å€¼è¶Šå¤§ï¼Œåˆ™è¡¨ç¤ºç›¸ä¼¼æ€§è¶Šé«˜ï¼Œå›¾åƒå»æ¨¡ç³Šæ•ˆæœè¶Šå¥½ã€‚
SSIMæ˜¯ä¸€ç§ç¬¦åˆäººç±»ç›´è§‰çš„å›¾åƒè´¨é‡è¯„ä»·æ ‡å‡†ã€‚ä»åå­—ä¸Šæˆ‘ä»¬ä¸éš¾å‘ç°ï¼Œè¿™ç§æŒ‡æ ‡æ˜¯åœ¨è‡´åŠ›äºå‘äººç±»çš„çœŸå®æ„ŸçŸ¥çœ‹é½ï¼Œè¯¦ç»†ç»†èŠ‚å¯ä»¥å‚è€ƒåŸè®ºæ–‡ã€‚

- MSSIM
MSSIMç›¸å½“äºæ˜¯åœ¨å¤šä¸ªå°ºåº¦ä¸Šæ¥è¿›è¡ŒSSIMæŒ‡æ ‡çš„æµ‹è¯•ï¼Œç›¸å¯¹äºSSIMï¼Œå…¶èƒ½æ›´å¥½çš„è¡¡é‡å›¾åƒåˆ°è§‚çœ‹è€…çš„è·ç¦»ã€åƒç´ ä¿¡æ¯å¯†é›†ç¨‹åº¦ç­‰å› ç´ å¯¹è§‚çœ‹è€…ç»™å‡ºçš„ä¸»è§‚è¯„ä»·æ‰€äº§ç”Ÿçš„å½±å“ã€‚
è®ºæ–‡ä¸­ç»™å‡ºçš„ä¸€ä¸ªä¾‹å­æ˜¯ï¼Œè§‚çœ‹è€…ç»™ä¸€ä¸ªåˆ†è¾¨ç‡ä¸º1080pçš„è¾ƒä¸ºæ¨¡ç³Šçš„ç”»é¢çš„è¯„åˆ†å¯èƒ½ä¼šæ¯”åˆ†è¾¨ç‡ä¸º720pçš„è¾ƒä¸ºé”åˆ©çš„ç”»é¢çš„è¯„åˆ†é«˜ã€‚å› æ­¤åœ¨è¯„ä»·å›¾åƒè´¨é‡çš„æ—¶å€™ä¸è€ƒè™‘å°ºåº¦å› ç´ å¯èƒ½ä¼šå¯¼è‡´å¾—å‡ºç‰‡é¢çš„ç»“æœã€‚
MSSIMæå‡ºåœ¨ä¸åŒåˆ†è¾¨ç‡ï¼ˆå°ºåº¦ï¼‰ä¸‹å¤šæ¬¡è®¡ç®—ç»“æ„ç›¸ä¼¼åº¦åç»¼åˆç»“æœå¾—åˆ°æœ€ç»ˆçš„è¯„ä»·æ•°å€¼ã€‚å…¶è®¡ç®—è¿‡ç¨‹æ¡†å›¾å¦‚ä¸‹æ‰€ç¤ºï¼š

<div align=center>
    <!-- ![åº”ç”¨åœºæ™¯](./img/16cvåº”ç”¨åœºæ™¯.jpg) -->
    <img src="./img/ch5/11.jpg" width="400"/>
</div>


##### æŒ‡æ ‡å®ç°
PSNR çš„è®¡ç®—æ–¹å¼å®šä¹‰å¦‚ä¸‹
```
class PSNR(nn.Module):
    def forward(self,img1,img2):
        mse = ((img1 - img2) ** 2).mean() # è¾“å‡ºå›¾åƒå’Œå‚è€ƒå›¾åƒçš„ MSE
        psnr = 10 * torch.log10(1.0 * 1.0 / (mse + 10 ** (-10)))
        return psnr
```

SSIM å’Œ MSSIM çš„è®¡ç®—è¾ƒä¸ºå¤æ‚ï¼Œåœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ç›´æ¥è°ƒç”¨ pytorch-msssim çš„æ¥å£æ¥è¿›è¡Œè®¡ç®—ã€‚

```
ssim = pytorch_msssim.SSIM(data_range=1.0, size_average=True, channel=3)
mssim = pytorch_msssim.MS_SSIM(data_range=1.0, size_average=True, channel=3)
```

å®ä¾‹åŒ–ä¹‹åä¸º

```
ssim = pytorch_msssim.SSIM(data_range=1.0, size_average=True, channel=3)
mssim = pytorch_msssim.MS_SSIM(data_range=1.0, size_average=True, channel=3)
psnr = PSNR()
```

### æ­¥éª¤11 æ¨¡å‹é¢„æµ‹:
æœ¬å°èŠ‚ä¸ºæ¨¡å‹é¢„æµ‹éƒ¨åˆ†ï¼Œå…·ä½“åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†
1. ç»˜å›¾å‡½æ•°å®šä¹‰
2. æ¨¡å‹åŠ è½½
3. æ•°æ®åŠ è½½
4. æ¨¡å‹é¢„æµ‹ä¸æŒ‡æ ‡åˆ†æ
5. ç»“æœå±•ç¤ºä¸ä¿å­˜
   
##### ç»˜å›¾å‡½æ•°å®šä¹‰
äº†æ–¹ä¾¿ç»˜åˆ¶ç»“æœï¼Œå®šä¹‰ç»˜å›¾å‡½æ•°ä¸º
```
def plot_tensor(tensor):
    if tensor.dim() == 4:
        tensor = tensor.squeeze(0)
    ret = transforms.ToPILImage()(tensor.squeeze(0))
    plt.imshow(ret) 
    return
```

##### æ¨¡å‹åŠ è½½
åœ¨ 3.3 èŠ‚çš„è®­ç»ƒè¿‡ç¨‹ä¸­æˆ‘ä»¬ä¿å­˜äº†å¤šä¸ª checkpoint ï¼Œç°åœ¨å¯¹å…¶è¿›è¡ŒåŠ è½½å’Œæµ‹è¯•ã€‚è¿™é‡Œæˆ‘ä»¬æä¾›äº†ä¸¤ç§é€‰æ‹© checkpoint çš„æ–¹å¼ï¼Œä¸€ç§æ˜¯é€‰æ‹©æŒ‡å®š checkpointï¼Œä¸€ç§æ˜¯é€‰æ‹©æœ€æ–°çš„ checkpointã€‚åœ¨è¿™é‡Œæˆ‘ä»¬ä»¥æœ€æ–°çš„ checkpoint ä¸ºä¾‹è¿›è¡Œæµ‹è¯•
```
# option-A ï¼šæµ‹è¯•æŒ‡å®šepoch
# best_epoch = 100 
# best_cp = f"{args.save_cp_dir}/Epoch_{best_epoch}.pt"

# option-B ï¼šæµ‹è¯•æœ€ç»ˆepoch
# best_cp = f"{args.save_cp_dir}/Epoch_lastest.pt"
best_cp = f"{args.save_cp_dir}/Epoch_0.pt"

my_model.to("cpu").load_state_dict(torch.load(best_cp))
my_model = my_model.eval()
```

##### æ•°æ®åŠ è½½
ç”±äºæ­¤æ¨¡å‹é‡‡ç”¨çš„æ˜¯å¤šå°ºåº¦è®­ç»ƒï¼Œå› æ­¤å¯¹äºå•å¼ è¾“å…¥å›¾åƒï¼Œéœ€è¦å¯¹å…¶è¿›è¡Œå¤„ç†ï¼Œå®šä¹‰åŠ è½½å›¾åƒçš„å‡½æ•° load_images ä¸º
```
def load_images(blur_img_path, multi):
    target_s1 = None
    sharp_img_path = blur_img_path.replace('blur', 'sharp')
    if os.path.exists(sharp_img_path):
        img_target = Image.open(sharp_img_path).convert('RGB')
        target_s1 = transforms.ToTensor()(img_target).unsqueeze(0)

    img_input = Image.open(blur_img_path).convert('RGB') # è½¬åŒ–ä¸º Image ç±»å‹æ–¹ä¾¿è¿›è¡Œ resize
    input_b1 = transforms.ToTensor()(img_input)

    if multi:
        H = input_b1.size()[1] # è·å–é«˜åº¦
        W = input_b1.size()[2] # è·å–å®½åº¦

        input_b1 = transforms.ToPILImage()(input_b1)
        input_b2 = transforms.ToTensor()(transforms.Resize([int(H / 2), int(W / 2)])(input_b1)).unsqueeze(0)
        input_b3 = transforms.ToTensor()(transforms.Resize([int(H / 4), int(W / 4)])(input_b1)).unsqueeze(0)

        input_b1 = transforms.ToTensor()(input_b1).unsqueeze(0)
        
        return {'input_b1': input_b1, 'input_b2': input_b2, 'input_b3': input_b3,
                'target_s1': target_s1}
    else:
        return {'input_b1': input_b1.unsqueeze(0), 'target_s1': target_s1}
```

##### æ¨¡å‹é¢„æµ‹ä¸æŒ‡æ ‡åˆ†æ
1. æ¨¡å‹é¢„æµ‹
åŠ è½½å›¾ç‰‡å¹¶æµ‹è¯•ï¼Œè¿™é‡Œä½¿ç”¨çš„æ˜¯æµ‹è¯•é›†é‡Œçš„å›¾ç‰‡ï¼ˆæ”¾åœ¨äº† pictures/ ä¸‹ï¼‰
```
idx = 1 # optionï¼š[1, 2, 3, 4]
blur_img_path = f"datasets/pictures/blur/test{idx}.png"
item = load_images(blur_img_path,args.multi)
input_b1 = item['input_b1']
input_b2 = item['input_b2']
input_b3 = item['input_b3']
target_s1 = item['target_s1']
output_l1, _, _ = my_model((input_b1, input_b2, input_b3))
```




2. æŒ‡æ ‡åˆ†æ
åŸå§‹æ¨¡ç³Šå›¾ç‰‡ä¸ä¸æ¨¡ç³Šçš„å›¾ç‰‡ä¹‹é—´çš„æŒ‡æ ‡è®¡ç®—
```
blur_psnr = psnr(input_b1,target_s1)
blur_ssim = ssim(input_b1,target_s1)
blur_mssim = mssim(input_b1,target_s1)
print(f"åŸå§‹æ¨¡ç³Šå›¾ç‰‡ï¼šPSNR={blur_psnr.float()}ï¼ŒSSIM={blur_ssim.float()}ï¼ŒMSSIM={blur_mssim.float()}")
```
ç½‘ç»œè¾“å‡ºå»æ¨¡ç³Šå›¾ç‰‡ä¸ä¸æ¨¡ç³Šçš„å›¾ç‰‡ä¹‹é—´çš„æŒ‡æ ‡è®¡ç®—

```
output_psnr = psnr(output_l1,target_s1)
output_ssim = ssim(output_l1,target_s1)
output_mssim = mssim(output_l1,target_s1)
print(f"ç½‘ç»œè¾“å‡ºå›¾ç‰‡ï¼šPSNR={output_psnr.float()}ï¼ŒSSIM={output_ssim.float()}ï¼ŒMSSIM={output_mssim.float()}")
```

##### ç»“æœå±•ç¤ºä¸ä¿å­˜
ä»ä¸Šå¾€ä¸‹ï¼Œä¾æ¬¡æ˜¯åŸå§‹å›¾ç‰‡ï¼Œè¾“å‡ºå›¾ç‰‡ï¼Œæ ‡ç­¾å›¾ç‰‡ï¼ˆæœªæ¨¡ç³Šå›¾ç‰‡ï¼‰
```
plt.figure(figsize=(6,10))
plt.subplot(311);plot_tensor(input_b1)
plt.subplot(312);plot_tensor(output_l1)
plt.subplot(313);plot_tensor(target_s1)
```

å°†ç»“æœä¿å­˜åœ¨ result æ–‡ä»¶å¤¹ä¸‹
```
save_name = blur_img_path.split("/")[-1]
save_path = os.path.join(args.save_dir,save_name)
save_img = transforms.ToPILImage()(output_l1.squeeze(0))
save_img.save(save_path)
```




## 5.ä»»åŠ¡æ‹“å±•
### 5.1 å¯¹å½©è‰²å›¾åƒè¿›è¡Œå›¾åƒå¢å¼ºå’Œå¯¹ç°åº¦å›¾åƒè¿›è¡Œå›¾åƒå¢å¼ºçš„åŒºåˆ«ï¼Ÿ

- ç›¸ä¿¡åŒå­¦ä»¬éƒ½æœ‰ç•™æ„åˆ°ï¼Œæˆ‘ä»¬è¯¾ç¨‹ä¸­æä¾›çš„å›¾ç‰‡å¤„ç†éƒ½æ˜¯é‡‡ç”¨å¯¹å½©è‰²å›¾ç‰‡è¿›è¡Œå¤„ç†ï¼Œä¹Ÿæ˜¯æ›´åŠ å…·æœ‰ç°å®æ„ä¹‰ã€‚
- é‚£ä¹ˆï¼Œå› ä¸ºé€šå¸¸æˆ‘ä»¬çš„å½©è‰²å›¾ç‰‡æ˜¯æœ‰Rï¼ŒGï¼ŒBä¸‰ä¸ªé€šé“ï¼Œå°±æ˜¯ä¹‹å‰è¯¾ç¨‹ä¸­æåŠçš„ï¼Œæœ‰ä¸‰åŸè‰²ç»„æˆæˆ‘ä»¬æ¯ä¸ªåƒç´ çš„çœŸå®è‰²å½©ã€‚å¦‚æœè¦å¤„ç†å…¨å½©è‰²å›¾åƒï¼Œåˆ™éœ€è¦å¯¹å½©è‰²çš„æ¯ä¸ªé€šé“åˆ†åˆ«å¤„ç†ï¼Œç„¶åå åŠ åœ¨ä¸€èµ·ã€‚ä¸‹é¢ä»¥ä¸­å€¼æ»¤æ³¢ä¸ºä¾‹ï¼Œå¯¹å½©è‰²å›¾åƒè¿›è¡Œå¤„ç†ã€‚

### 5.2 ä¼ªå½©è‰²ï¼Ÿ

- å°†å½©è‰²å›¾åƒè½¬æ¢ä¸ºç°åº¦å›¾åƒæ˜¯ä¸€ä¸ªä¸å¯é€†çš„è¿‡ç¨‹ï¼Œç°åº¦å›¾åƒä¹Ÿä¸å¯èƒ½å˜æ¢ä¸ºåŸæ¥çš„å½©è‰²å›¾åƒã€‚è€ŒæŸäº›åœºåˆéœ€è¦å°†ç°åº¦å›¾åƒè½¬å˜ä¸ºå½©è‰²å›¾åƒï¼›ä¼ªå½©è‰²å¤„ç†ä¸»è¦æ˜¯æŠŠé»‘ç™½çš„ç°åº¦å›¾åƒæˆ–è€…å¤šæ³¢æ®µå›¾åƒè½¬æ¢ä¸ºå½©è‰²å›¾åƒçš„æŠ€æœ¯è¿‡ç¨‹ã€‚å…¶ç›®çš„æ˜¯æé«˜å›¾åƒå†…å®¹çš„å¯è¾¨è¯†åº¦ã€‚

- ä¼ªå½©è‰²å›¾åƒçš„å«ä¹‰æ˜¯ï¼Œæ¯ä¸ªåƒç´ çš„é¢œè‰²ä¸æ˜¯ç”±æ¯ä¸ªåŸºè‰²åˆ†é‡çš„æ•°å€¼ç›´æ¥å†³å®šï¼Œè€Œæ˜¯æŠŠåƒç´ å€¼å½“ä½œå½©è‰²æŸ¥æ‰¾è¡¨(äº‹å…ˆåšå¥½çš„)çš„è¡¨é¡¹å…¥å£åœ°å€ï¼Œå»æŸ¥æ‰¾ä¸€ä¸ªæ˜¾ç¤ºå›¾åƒæ—¶ä½¿ç”¨çš„Rï¼ŒGï¼ŒBå¼ºåº¦å€¼ï¼Œç”¨æŸ¥æ‰¾å‡ºçš„Rï¼ŒGï¼ŒBå¼ºåº¦å€¼äº§ç”Ÿçš„å½©è‰²ç§°ä¸ºä¼ªå½©è‰²ã€‚


### 5.3 æ·±åº¦å­¦ä¹ æ¨¡å‹ä¼˜åŒ–æ€è·¯å’Œæ–¹æ³•
- ä½¿ç”¨L1æŸå¤±å‡½æ•°ã€‚
- åœ¨æ®‹å·®ç»“æ„ä¸­åŠ å…¥Batch Normalizationå’ŒReLUã€‚



## 6. ä»»åŠ¡å®è®­
### 6.1 å®è®­ç›®çš„
- æŒæ¡è°ƒç”¨ç™¾åº¦ api
- åŠ æ·±å¯¹å›¾åƒå¢å¼ºçš„ç†è§£
- æ‹“å±•å›¾åƒå¢å¼ºçš„åº”ç”¨çŸ¥è¯†

### 6.2 å®è®­å†…å®¹

- æˆ‘ä»¬å·²ç»æˆåŠŸä¸€äº›ä¼ ç»Ÿçš„å›¾åƒå¤„ç†æ–¹æ³•å¯¹å›¾ç‰‡è¿›è¡Œå¢å¼ºï¼Œè€Œç™¾åº¦ AI å¼€æ”¾å¹³å°è¿˜æä¾›çš„åŸºäºæ·±åº¦å­¦ä¹ çš„å›¾åƒå¢å¼ºç®—æ³•æä¾›æˆ‘ä»¬è°ƒç”¨ã€‚

### 6.3 ç¤ºä¾‹ä»£ç 

```
%matplotlib inline
import cv2
import numpy as np

from matplotlib import pyplot as plt

import sys
import json
import base64

import ssl
## make it work in both python2 both python3
IS_PY3 = sys.version_info.major == 3
if IS_PY3:
    from urllib.request import urlopen
    from urllib.request import Request
    from urllib.error import URLError
    from urllib.parse import urlencode
    from urllib.parse import quote_plus
else:
    import urllib2
    from urllib import quote_plus
    from urllib2 import urlopen
    from urllib2 import Request
    from urllib2 import URLError
    from urllib import urlencode


## è·³è¿‡ HTTPS èº«ä»½éªŒè¯
ssl._create_default_https_context = ssl._create_unverified_context
API_KEY = 'ä½ çš„API_KEY'
SECRET_KEY = 'ä½ çš„SECRET_KEY'
IMG_ENHANCE = "https://aip.baidubce.com/rest/2.0/image-process/v1/contrast_enhance"
""" å¼€å§‹ TOKEN """
TOKEN_URL = 'https://aip.baidubce.com/oauth/2.0/token'


""" è¯·æ±‚è®¤è¯ token
"""
def fetch_token():
    params = {'grant_type': 'client_credentials',
        'client_id': API_KEY,
        'client_secret': SECRET_KEY}
    post_data = urlencode(params)
    if (IS_PY3):
        post_data = post_data.encode('utf-8')
    req = Request(TOKEN_URL, post_data)
    try:
        f = urlopen(req, timeout=5)
        result_str = f.read()
    except URLError as err:
        print(err)
    if (IS_PY3):
        result_str = result_str.decode()
    result = json.loads(result_str)
    if ('access_token' in result.keys() and 'scope' in result.keys()):
        if not 'brain_all_scope' in result['scope'].split(' '):
            print ('please ensure has check the ability')
            exit()
        return result['access_token']
    else:
        print ('please overwrite the correct API_KEY and SECRET_KEY')
        exit()


""" è¯»å–å›¾ç‰‡å‡½æ•°
"""

def read_file(image_path):
    f = None
    try:
        f = open(image_path, 'rb') #ç”¨äºŒè¿›åˆ¶æ‰“å¼€å›¾ç‰‡
        return f.read()
    except:
        print('read image file fail')
        return None
    finally:
        if f:
            f.close()


"""
call remote http server
"""
def request(url, data):
    req = Request(url, data.encode('utf-8'))
    has_error = False
    try:
        f = urlopen(req)
        result_str = f.read()
        if (IS_PY3):
            result_str = result_str.decode()
        return result_str
    except URLError as err:
        print(err)


if __name__ == '__main__':
    ## get access token
    token = fetch_token()
    ## concat url
    url = IMG_ENHANCE + "?access_token=" + token
    
    file_content = read_file('./img2.jpg')
    response = request(url, urlencode(
    {
        'image': base64.b64encode(file_content),
        'image_type': 'BASE64',
    }))
    data = json.loads(response)
#     print(data)
    sourceImg = cv2.imread('img2.jpg')
    srcImage_new = cv2.cvtColor(sourceImg, cv2.COLOR_BGR2RGB)
    plt.imshow(srcImage_new)
    plt.show()


image_data = base64.b64decode(data['image'])
with open('2.jpg', 'wb') as f:
    f.write(image_data)
sourceImg = cv2.imread('2.jpg')
srcImage_new = cv2.cvtColor(sourceImg, cv2.COLOR_BGR2RGB)
plt.imshow(srcImage_new)
plt.show()



```

### 6.4 å­¦åå°æµ‹è¯•:ï¼ˆå¿…åšé¢˜ï¼‰
1. æ¡ˆä¾‹ä¸­æ¨¡å‹ä½¿ç”¨çš„æŸå¤±å‡½æ•°æ˜¯ï¼Ÿ ã€åˆ†å€¼ï¼š20ã€‘
A. äº¤å‰ç†µå‡½æ•° B.MSE C.MAE D.Log-Cosh
2. ä¸ä¼ ç»Ÿçš„æ®‹å·®ç»“æ„ç›¸æ¯”ï¼Œæ¡ˆä¾‹ä¸­çš„æ®‹å·®ç»“æ„å°‘äº†å“ªäº›æ“ä½œï¼Ÿ ã€åˆ†å€¼ï¼š20ã€‘
A. Batch Normalization B.å·ç§¯ C.shortcut D.ReLU E.æ± åŒ–å±‚
1. æ¨¡å‹ä¸­çš„ä¸Šé‡‡æ ·æ“ä½œå¯ä»¥ç”¨åå·ç§¯æ“ä½œä»£æ›¿ ã€åˆ†å€¼ï¼š20ã€‘
2. æŸå¤±å‡½æ•°ä¸­æ¯ä¸€å±‚çš„æŸå¤±å‡½æ•°éƒ½ç”¨é€šé“æ•°ï¼Œå®½åº¦å’Œé«˜åº¦è¿›è¡Œäº†å½’ä¸€åŒ– ã€åˆ†å€¼ï¼š20ã€‘
3. ä¸ºäº†æ•æ‰ä¸åŒå°ºåº¦çš„å›¾åƒä¿¡æ¯ï¼Œæ¨¡å‹é‡‡ç”¨äº†ä»€ä¹ˆç»“æ„ï¼Ÿ ã€åˆ†å€¼ï¼š20ã€‘
4. æ¡ˆä¾‹ä¸­æ¨¡å‹é‡‡ç”¨æ®‹å·®å½¢å¼çš„CNNæœ‰ä»€ä¹ˆå¥½å¤„ï¼Ÿ ã€åˆ†å€¼ï¼š0ã€‘